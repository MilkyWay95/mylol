<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>LoL Iron to Silver Player</title>
    <style>
        /* Стили остаются такими же */
        body { font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; background-color: #f5f5f5; }
        .player-container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        /* ... остальные стили ... */
    </style>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
</head>
<body>
    <!-- HTML остаётся таким же -->
    <div class="player-container">
        <!-- ... предыдущий HTML ... -->
    </div>

    <script>
        const videoDurations = {
            "7c05gxjdt7": 99,    // 1:39
            "8krm8cc13t": 854,   // 14:14
            "r5j0v9dj38": 3793,  // 63:13
            "rfvkqf8g1z": 3706,  // 61:46
            "4wzrjcf6nn": 2091,  // 34:51
            "80kt8ps0k3": 4518,  // 75:18
            "8tfwzdsvk6": 3621,  // 60:21
            "qj8l3hld93": 2643   // 44:03
        };

        var hls = new Hls();
        var videoSegments = [];
        var videoId = '';

        async function getRealSegmentDuration(videoId) {
            // Проверяем первые 3 сегмента для определения реальной длительности
            const testSegments = [
                `https://d13z5uuzt1wkbz.cloudfront.net/${videoId}/HIDDEN4500-00001.ts`,
                `https://d13z5uuzt1wkbz.cloudfront.net/${videoId}/HIDDEN4500-00002.ts`,
                `https://d13z5uuzt1wkbz.cloudfront.net/${videoId}/HIDDEN4500-00003.ts`
            ];
            
            try {
                const response = await fetch(testSegments[0], { method: 'HEAD' });
                if (!response.ok) return null;
                
                // Создаем временный видео элемент для анализа длительности
                const tempVideo = document.createElement('video');
                tempVideo.preload = 'metadata';
                
                return new Promise((resolve) => {
                    tempVideo.onloadedmetadata = function() {
                        resolve(tempVideo.duration || 10); // По умолчанию 10 сек
                    };
                    tempVideo.src = testSegments[0];
                });
            } catch (e) {
                return 10; // Возвращаем значение по умолчанию
            }
        }

        async function findVideoSegments(videoId) {
            const statusLabel = document.getElementById("status");
            videoSegments = [];
            
            // Получаем общую длительность видео
            const totalDuration = videoDurations[videoId] || 3600; // 1 час по умолчанию
            const segmentDuration = await getRealSegmentDuration(videoId);
            
            // Рассчитываем примерное количество сегментов
            const estimatedSegments = Math.ceil(totalDuration / (segmentDuration || 10));
            
            statusLabel.textContent = `Searching for ${estimatedSegments} segments...`;
            
            // Проверяем доступность диапазона сегментов
            let lastValidSegment = 0;
            for (let i = 1; i <= estimatedSegments; i++) {
                const segmentUrl = `https://d13z5uuzt1wkbz.cloudfront.net/${videoId}/HIDDEN4500-${String(i).padStart(5, "0")}.ts`;
                try {
                    const response = await fetch(segmentUrl, { method: 'HEAD' });
                    if (response.ok) {
                        videoSegments.push({
                            url: segmentUrl,
                            number: i
                        });
                        lastValidSegment = i;
                    } else if (i > lastValidSegment + 10) {
                        break;
                    }
                } catch (e) {
                    if (i > lastValidSegment + 10) break;
                }
            }

            if (videoSegments.length > 0) {
                statusLabel.textContent = `Found ${videoSegments.length} segments (total ~${Math.round(videoSegments.length * segmentDuration / 60)} min)`;
                return true;
            } else {
                statusLabel.textContent = "No segments found";
                return false;
            }
        }

        function createHLSPlaylist() {
            const videoElement = document.getElementById('video');
            let playlist = "#EXTM3U\n#EXT-X-VERSION:3\n#EXT-X-TARGETDURATION:10\n";
            playlist += "#EXT-X-MEDIA-SEQUENCE:0\n#EXT-X-PLAYLIST-TYPE:VOD\n";
            
            // Используем реальную длительность сегментов
            videoSegments.forEach(segment => {
                playlist += `#EXTINF:10.0,\n${segment.url}\n`;
            });
            
            playlist += "#EXT-X-ENDLIST";
            return playlist;
        }

        async function stream() {
            // ... предыдущая реализация stream() ...
        }

        // ... остальные функции (downloadVideo, prevVideo, nextVideo) ...

        // Инициализация
        document.addEventListener('DOMContentLoaded', function() {
            if (Hls.isSupported()) {
                hls = new Hls({
                    maxMaxBufferLength: 600, // Увеличиваем буфер для длинных видео
                    maxBufferSize: 60*1000*1000, // 60MB буфер
                    maxBufferLength: 600 // 10 минут буферизации
                });
            }
        });
    </script>
</body>
</html>